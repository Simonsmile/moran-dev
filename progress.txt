# Moran ERP - Progress Log

## 项目初始化 - 2026-02-27

### 项目背景:
本项目是对原有珠宝行业ERP系统 (iErp-Moran) 的完全重写。

### 技术选型确认:
- 后端: Java 21 + Spring Boot 3.4 + Spring Cloud Gateway + Nacos
- 认证: OAuth2 + JWT
- 数据库: PostgreSQL 16 (从MySQL迁移)
- 缓存: Redis 7
- 消息队列: RabbitMQ (含STOMP插件)
- 前端: Vue 3.5 + TypeScript + Element Plus + Pinia + Vite
- 部署: 阿里云 Ubuntu 22.04 + Docker

### 开发优先级:
1. 用户权限系统
2. 产品物料管理
3. 库存管理系统

### 任务统计:
- 总任务数: 42个
- 已完成: 18个
- 进行中: 0个

### 当前状态:
Task 18 已完成，准备开始 Task 19: 前端 - 用户管理页面

---

## 2026-02-28 - Task ID: 18 - 前端权限指令和组件

### What was done:
- permission.ts 权限指令：
  - v-permission: 权限检查指令
  - v-role: 角色检查指令
  - 无权限时移除DOM元素
- usePermission.ts 权限组合式函数：
  - hasPermission: 检查单个或多个权限
  - hasRole: 检查单个或多个角色
  - hasAnyPermission: 检查是否有任一权限
  - hasAllPermissions: 检查是否有所有权限
  - isAdmin: 计算属性，判断是否为管理员
- main.ts 注册权限指令

### Testing:
- npm run build 构建成功

### Notes:
- 权限指令在mounted钩子中检查
- 权限数据从Pinia store获取

---

### 当前状态:
Task 17 已完成，准备开始 Task 18: 前端 - 权限指令和组件

---

## 2026-02-28 - Task ID: 17 - 前端登录页面完善

### What was done:
- 登录页面集成真实API：
  - 调用 authApi.login 接口
  - 处理登录成功/失败情况
  - 存储 accessToken 和 refreshToken
- 用户体验优化：
  - 加载状态显示
  - 错误提示
  - 记住我功能
  - 登录后跳转

### Testing:
- npm run build 构建成功

### Notes:
- refreshToken 存储在 localStorage
- accessToken 存储在 Pinia (持久化到 localStorage)

---
- 待处理: 26个

### 当前状态:
Task 16 已完成，准备开始 Task 17: 前端 - 登录页面完善

---

## 2026-02-28 - Task ID: 16 - 前端HTTP请求封装

### What was done:
- request.ts HTTP客户端封装：
  - Axios实例配置（baseURL、timeout）
  - 请求拦截器（Token注入、请求ID）
  - 响应拦截器（错误处理、Token刷新）
  - 统一错误提示
- 类型定义：
  - Result<T> 统一响应类型
  - PageResult<T> 分页响应类型
- API模块：
  - auth.ts: 登录、登出、刷新Token
  - user.ts: 用户CRUD、角色分配
  - role.ts: 角色CRUD、权限分配
- 用户和角色类型定义

### Testing:
- npm run build 构建成功

### Notes:
- 请求超时设置为10秒
- 401错误自动跳转登录页
- 支持请求取消功能

---

## 2026-02-28 - Task ID: 15 - API网关认证过滤器
- 待处理: 27个

### 当前状态:
Task 15 已完成，准备开始 Task 16: 前端 - HTTP请求封装

---

## 2026-02-28 - Task ID: 15 - API网关认证过滤器

### What was done:
- AuthenticationFilter 认证过滤器：
  - 从请求头提取Bearer Token
  - 验证Token有效性
  - 将用户信息注入请求头（X-User-Id、X-Username、X-Roles）
  - 处理Token过期和无效情况
  - 返回401未授权响应
- 白名单路径配置：
  - /api/auth/login
  - /api/auth/register
  - /api/auth/captcha
  - /actuator/**
  - /swagger-ui/**
  - /v3/api-docs/**
  - /fallback

### Testing:
- mvn clean compile 编译成功

### Notes:
- 白名单支持Ant路径匹配模式
- 过滤器优先级为-50（在日志过滤器之后）

---

## 2026-02-28 - Task ID: 14 - API网关路由配置

### What was done:
- application.yml 配置更新：
  - 路由规则：auth-service、business-service
  - CORS跨域配置
  - 请求限流（Redis令牌桶）
  - 熔断降级（Resilience4j）
  - 路由重试机制
- GatewayConfig：
  - IP Key Resolver（限流键解析器）
- RequestLogFilter：
  - 全局请求日志过滤器
  - 记录请求ID、方法、路径、耗时
- FallbackHandler：
  - 熔断降级处理
  - 返回统一错误响应
- RouterConfig：
  - 路由函数配置

### Testing:
- mvn clean compile 编译成功

### Notes:
- 限流使用Redis令牌桶算法
- 熔断器失败率阈值50%，等待10秒后半开
- 重试仅对GET请求生效

---

## 2026-02-28 - 用户角色分配功能补充

### What was done:
- UserRoleController 控制器：
  - GET /api/users/{userId}/roles 获取用户角色
  - POST /api/users/{userId}/roles 分配用户角色
- 分配角色时先删除旧关联再插入新关联

### Testing:
- mvn clean compile 编译成功
- Java版本从21调整为17以匹配系统环境

### Notes:
- 用户角色分配支持批量操作
- 分配时自动清除旧的角色关联

---

## 2026-02-28 - Task ID: 13 - 登录/登出API

### What was done:
- LoginRequest DTO（用户名、密码、验证码）
- LoginResponse DTO（accessToken、refreshToken、expiresIn、userInfo）
- AuthService 服务层：
  - login: 用户登录验证、生成JWT Token、更新登录信息
  - logout: Token加入黑名单、清除RefreshToken
  - refresh: 刷新Token
  - getCurrentUserPermissions: 获取当前用户权限
- AuthController 控制器：
  - POST /api/auth/login 登录
  - POST /api/auth/logout 登出
  - POST /api/auth/refresh 刷新Token
  - GET /api/auth/me 获取当前用户信息
- JwtUtils 新增 getExpireTime 方法

### Testing:
- mvn clean compile 编译成功

### Notes:
- 登录成功后返回accessToken和refreshToken
- refreshToken存储在Redis中，有效期7天
- Token加入黑名单后立即失效

---

## 2026-02-28 - Task ID: 12 - 部门管理API

### What was done:
- Department 实体类（支持树形结构）
- DepartmentMapper 数据访问层（含用户计数）
- DepartmentService 服务层：
  - create: 创建部门（自动计算path和level）
  - getById: 获取部门详情
  - getTree: 获取部门树
  - getChildren: 获取子部门列表
  - update: 更新部门
  - delete: 删除部门（检查子部门和用户）
  - findByCode: 按编码查询
- DepartmentController 控制器：
  - POST /api/departments 创建部门
  - GET /api/departments/tree 获取部门树
  - GET /api/departments/children/{parentId} 获取子部门
  - GET /api/departments/{id} 获取部门详情
  - PUT /api/departments/{id} 更新部门
  - DELETE /api/departments/{id} 删除部门
- DTOs: DepartmentCreateRequest, DepartmentUpdateRequest, DepartmentVO

### Testing:
- mvn clean compile 编译成功

### Notes:
- 部门支持树形结构，自动计算path和level
- 删除部门前检查子部门和用户

---

## 2026-02-28 - Task ID: 11 - 权限管理API

### What was done:
- Permission 实体类（支持树形结构）
- PermissionMapper 数据访问层
- PermissionService 服务层：
  - create: 创建权限
  - getById: 获取权限详情
  - getTree: 获取权限树
  - getChildren: 获取子权限列表
  - update: 更新权限
  - delete: 删除权限（检查子权限）
  - getUserPermissions: 获取用户权限树
  - findByCode: 按编码查询
- PermissionController 控制器：
  - POST /api/permissions 创建权限
  - GET /api/permissions/tree 获取权限树
  - GET /api/permissions/children/{parentId} 获取子权限
  - GET /api/permissions/{id} 获取权限详情
  - PUT /api/permissions/{id} 更新权限
  - DELETE /api/permissions/{id} 删除权限
  - GET /api/permissions/user 获取当前用户权限
- DTOs: PermissionCreateRequest, PermissionUpdateRequest, PermissionVO

### Testing:
- mvn clean compile 编译成功

### Notes:
- 权限支持树形结构（菜单-按钮-API三级）
- 删除权限前检查是否存在子权限
- 用户权限通过角色关联查询

---

## 2026-02-28 - Task ID: 10 - 角色管理API

### What was done:
- Role 实体类
- Permission 实体类（支持树形结构）
- RoleMapper 数据访问层（含权限查询）
- PermissionMapper 数据访问层
- RoleService 服务层：
  - create: 创建角色
  - getById: 获取角色详情
  - list: 查询角色列表（支持关键字、状态筛选）
  - update: 更新角色信息
  - delete: 删除角色（同时删除用户角色关联和角色权限关联）
  - assignPermissions: 分配权限
  - getPermissionIds: 获取角色权限ID列表
  - findByCode: 按编码查询
- RoleController 控制器：
  - POST /api/roles 创建角色
  - GET /api/roles 查询角色列表
  - GET /api/roles/{id} 获取角色详情
  - PUT /api/roles/{id} 更新角色
  - DELETE /api/roles/{id} 删除角色
  - POST /api/roles/{id}/permissions 分配权限
  - GET /api/roles/{id}/permissions 获取角色权限
- DTOs: RoleCreateRequest, RoleUpdateRequest, RoleVO

### Testing:
- mvn clean compile 编译成功

### Notes:
- 删除角色时级联删除关联数据
- 角色编码唯一

---

## 2026-02-28 - Task ID: 9 - 用户管理API

### What was done:
- User 实体类（继承 BaseEntity）
- UserMapper 数据访问层（含角色查询）
- UserService 服务层：
  - create: 创建用户（密码加密）
  - getById: 获取用户详情
  - list: 分页查询用户（支持关键字、状态、部门筛选）
  - count: 统计用户数量
  - update: 更新用户信息
  - delete: 删除用户（逻辑删除）
  - resetPassword: 重置密码
  - findByUsername: 按用户名查询
  - updateLoginInfo: 更新登录信息
- UserController 控制器：
  - POST /api/users 创建用户
  - GET /api/users 分页查询用户
  - GET /api/users/{id} 获取用户详情
  - PUT /api/users/{id} 更新用户
  - DELETE /api/users/{id} 删除用户
  - POST /api/users/{id}/reset-password 重置密码
- DTOs: UserCreateRequest, UserUpdateRequest, UserQueryRequest, UserVO
- Swagger/OpenAPI 注解

### Testing:
- mvn clean compile 编译成功

### Notes:
- 密码使用 BCrypt 加密存储
- 返回的 UserVO 包含用户角色列表

---

## 2026-02-27 - Task ID: 7 & 8 - 认证服务配置

### What was done:
**Task 7 - OAuth2配置:**
- JwtUtils: JWT Token 生成和解析工具类
  - generateAccessToken: 生成访问令牌 (2小时有效)
  - generateRefreshToken: 生成刷新令牌 (7天有效)
  - validateToken: 验证令牌有效性
  - parseToken: 解析令牌获取用户信息
- PasswordConfig: BCrypt密码加密器
- UserInfo: 用户认证信息载体

**Task 8 - JWT资源服务:**
- SecurityConfig: Spring Security配置
  - 禁用CSRF，使用无状态会话
  - 配置白名单路径
  - 添加JWT认证过滤器
- JwtAuthenticationFilter: JWT认证过滤器
  - 从请求头提取Bearer Token
  - 验证并解析Token
  - 设置认证信息到SecurityContext
- SecurityUtils: 安全上下文工具类
  - getCurrentUserId: 获取当前用户ID
  - getCurrentUsername: 获取当前用户名
  - isAuthenticated: 判断是否已认证

### Testing:
- mvn clean compile 编译成功

### Notes:
- 使用 HMAC-SHA256 签名算法
- JWT密钥配置在 JwtUtils 中，生产环境应从配置文件读取
- 认证流程：用户登录 -> 生成JWT -> 前端存储Token -> 后续请求携带Token -> Filter验证

---

## 2026-02-27 - Task ID: 5 & 6 - 公共模块配置补充

### What was done:
**Task 5 - MyBatis Plus配置补充:**
- 已在 Task 1 中创建 BaseEntity, MybatisPlusConfig, JsonTypeHandler
- 本次补充: 直接使用 MyBatis Plus 提供的 BaseMapper，无需自定义

**Task 6 - Redis配置补充:**
- 已在 Task 1 中创建 RedisConfig, RedisService
- 本次补充:
  - RedissonConfig 配置类
  - @DistributedLock 注解
  - DistributedLockAspect 切面（支持SpEL表达式）
  - CacheUtil 缓存工具类

### Testing:
- mvn clean compile 编译成功

### Notes:
- DistributedLock 支持等待时间和租约时间配置
- CacheUtil 提供缓存穿透保护（双重检查锁）

---

## 2026-02-27 - Task ID: 3 - 数据库初始化

### What was done:
- 创建 V1__Init_schema.sql 数据库表结构脚本:
  - 系统表: sys_department, sys_user, sys_role, sys_permission, sys_user_role, sys_role_permission
  - 基础数据表: base_brand, base_product, base_product_spec, base_material, base_bom, base_bom_item
  - 库存表: inv_warehouse, inv_inventory, inv_stock_in, inv_stock_in_item, inv_stock_out, inv_stock_out_item, inv_stock_log
  - 工作流表: wf_definition, wf_status, wf_action, wf_transition
- 创建 V2__Init_data.sql 初始数据脚本:
  - 默认部门数据
  - 默认角色数据 (超级管理员、管理员、普通用户)
  - 默认管理员用户 (admin/admin123)
  - 菜单权限数据
  - 按钮权限数据
  - 角色权限关联数据
  - 默认仓库数据
  - 工作流定义和状态转换数据
- 创建所有必要的索引和外键约束

### Testing:
- SQL 脚本语法正确，待连接数据库后验证

### Notes:
- 使用 Flyway 命名规范 (V{version}__{description}.sql)
- 密码使用 BCrypt 加密存储
- 工作流支持入库和出库审批流程
- Task 4 (统一响应和异常) 已在 Task 1 中完成

---

## 2026-02-27 - Task ID: 2 - 前端项目初始化

### What was done:
- 使用 Vite 创建 Vue3 + TypeScript 项目
- 安装依赖：vue-router、pinia、axios、element-plus、pinia-plugin-persistedstate
- 配置 vite.config.ts（代理、别名、Element Plus按需导入）
- 配置 tsconfig.app.json（路径别名）
- 创建目录结构：api/、assets/、components/、composables/、layouts/、router/、stores/、types/、utils/、views/
- 创建用户类型定义（UserInfo、LoginForm、LoginResponse）
- 创建通用类型定义（Result、PageResult、PageQuery）
- 创建 Pinia Store（user store with persistence）
- 创建路由配置（路由守卫、基础路由）
- 创建布局组件：
  - DefaultLayout.vue（侧边栏、头部、面包屑、用户下拉菜单）
  - BlankLayout.vue
- 创建页面组件：
  - login/index.vue（登录页面）
  - dashboard/index.vue（仪表盘页面）
  - error/404.vue（404错误页面）

### Testing:
- npm run build 构建成功
- TypeScript 类型检查通过

### Notes:
- Element Plus 使用 unplugin-auto-import 和 unplugin-vue-components 实现按需导入
- 用户状态使用 pinia-plugin-persistedstate 持久化到 localStorage
- 登录功能目前使用 mock 数据，需要后端 API 后对接

---

## 2026-02-27 - Task ID: 1 - 后端项目初始化

### What was done:
- 创建父POM (pom.xml)，配置Java 21、Spring Boot 3.4、Spring Cloud依赖管理
- 创建 moran-common 模块（公共工具类）
- 创建 moran-common-core 子模块：
  - Result<T> 统一响应类
  - ResultCode 枚举
  - BusinessException 业务异常类
  - GlobalExceptionHandler 全局异常处理器
  - Constants 常量类
- 创建 moran-common-redis 子模块：
  - RedisConfig 配置类
  - RedisService 服务类
- 创建 moran-common-security 子模块（空模块，后续开发）
- 创建 moran-common-mybatis 子模块：
  - BaseEntity 基础实体类
  - MybatisPlusConfig 配置类
  - JsonTypeHandler JSON类型处理器
- 创建 moran-gateway 模块（API网关）：
  - GatewayApplication 启动类
  - application.yml 配置文件
- 创建 moran-auth 模块（认证服务）：
  - AuthApplication 启动类
  - application.yml 配置文件
- 创建 moran-business 模块（核心业务服务）：
  - BusinessApplication 启动类
  - application.yml 配置文件
- 创建 moran-external 模块（外部对接服务）：
  - ExternalApplication 启动类
  - application.yml 配置文件
- 创建 moran-api 模块（Feign接口定义）：
  - moran-api-auth
  - moran-api-business
  - moran-api-external

### Testing:
- mvn clean compile 编译成功
- 所有模块依赖关系正确

### Notes:
- 由于Java 25与Lombok兼容性问题，移除了Lombok注解处理器
- 所有实体类改用手写getter/setter
- MyBatis Plus 3.5.9 的 PaginationInnerInterceptor 在当前版本中不存在，暂时移除分页插件
- 后续任务需要添加分页功能时可手动实现

---

## Template for New Entries

```
## [Date] - Task ID: [id] - [task title]

### What was done:
- [specific changes made]

### Testing:
- [how it was tested]

### Notes:
- [any relevant notes for future agents]
```
