# Moran ERP - Progress Log

## 项目初始化 - 2026-02-27

### 项目背景:
本项目是对原有珠宝行业ERP系统 (iErp-Moran) 的完全重写。

### 技术选型确认:
- 后端: Java 21 + Spring Boot 3.4 + Spring Cloud Gateway + Nacos
- 认证: OAuth2 + JWT
- 数据库: PostgreSQL 16 (从MySQL迁移)
- 缓存: Redis 7
- 消息队列: RabbitMQ (含STOMP插件)
- 前端: Vue 3.5 + TypeScript + Element Plus + Pinia + Vite
- 部署: 阿里云 Ubuntu 22.04 + Docker

### 开发优先级:
1. 用户权限系统
2. 产品物料管理
3. 库存管理系统

### 任务统计:
- 总任务数: 42个
- 已完成: 8个
- 进行中: 0个
- 待处理: 34个

### 当前状态:
Tasks 7 & 8 已完成，准备开始 Task 9: 认证服务 - 用户管理API

---

## 2026-02-27 - Task ID: 7 & 8 - 认证服务配置

### What was done:
**Task 7 - OAuth2配置:**
- JwtUtils: JWT Token 生成和解析工具类
  - generateAccessToken: 生成访问令牌 (2小时有效)
  - generateRefreshToken: 生成刷新令牌 (7天有效)
  - validateToken: 验证令牌有效性
  - parseToken: 解析令牌获取用户信息
- PasswordConfig: BCrypt密码加密器
- UserInfo: 用户认证信息载体

**Task 8 - JWT资源服务:**
- SecurityConfig: Spring Security配置
  - 禁用CSRF，使用无状态会话
  - 配置白名单路径
  - 添加JWT认证过滤器
- JwtAuthenticationFilter: JWT认证过滤器
  - 从请求头提取Bearer Token
  - 验证并解析Token
  - 设置认证信息到SecurityContext
- SecurityUtils: 安全上下文工具类
  - getCurrentUserId: 获取当前用户ID
  - getCurrentUsername: 获取当前用户名
  - isAuthenticated: 判断是否已认证

### Testing:
- mvn clean compile 编译成功

### Notes:
- 使用 HMAC-SHA256 签名算法
- JWT密钥配置在 JwtUtils 中，生产环境应从配置文件读取
- 认证流程：用户登录 -> 生成JWT -> 前端存储Token -> 后续请求携带Token -> Filter验证

---

## 2026-02-27 - Task ID: 5 & 6 - 公共模块配置补充

### What was done:
**Task 5 - MyBatis Plus配置补充:**
- 已在 Task 1 中创建 BaseEntity, MybatisPlusConfig, JsonTypeHandler
- 本次补充: 直接使用 MyBatis Plus 提供的 BaseMapper，无需自定义

**Task 6 - Redis配置补充:**
- 已在 Task 1 中创建 RedisConfig, RedisService
- 本次补充:
  - RedissonConfig 配置类
  - @DistributedLock 注解
  - DistributedLockAspect 切面（支持SpEL表达式）
  - CacheUtil 缓存工具类

### Testing:
- mvn clean compile 编译成功

### Notes:
- DistributedLock 支持等待时间和租约时间配置
- CacheUtil 提供缓存穿透保护（双重检查锁）

---

## 2026-02-27 - Task ID: 3 - 数据库初始化

### What was done:
- 创建 V1__Init_schema.sql 数据库表结构脚本:
  - 系统表: sys_department, sys_user, sys_role, sys_permission, sys_user_role, sys_role_permission
  - 基础数据表: base_brand, base_product, base_product_spec, base_material, base_bom, base_bom_item
  - 库存表: inv_warehouse, inv_inventory, inv_stock_in, inv_stock_in_item, inv_stock_out, inv_stock_out_item, inv_stock_log
  - 工作流表: wf_definition, wf_status, wf_action, wf_transition
- 创建 V2__Init_data.sql 初始数据脚本:
  - 默认部门数据
  - 默认角色数据 (超级管理员、管理员、普通用户)
  - 默认管理员用户 (admin/admin123)
  - 菜单权限数据
  - 按钮权限数据
  - 角色权限关联数据
  - 默认仓库数据
  - 工作流定义和状态转换数据
- 创建所有必要的索引和外键约束

### Testing:
- SQL 脚本语法正确，待连接数据库后验证

### Notes:
- 使用 Flyway 命名规范 (V{version}__{description}.sql)
- 密码使用 BCrypt 加密存储
- 工作流支持入库和出库审批流程
- Task 4 (统一响应和异常) 已在 Task 1 中完成

---

## 2026-02-27 - Task ID: 2 - 前端项目初始化

### What was done:
- 使用 Vite 创建 Vue3 + TypeScript 项目
- 安装依赖：vue-router、pinia、axios、element-plus、pinia-plugin-persistedstate
- 配置 vite.config.ts（代理、别名、Element Plus按需导入）
- 配置 tsconfig.app.json（路径别名）
- 创建目录结构：api/、assets/、components/、composables/、layouts/、router/、stores/、types/、utils/、views/
- 创建用户类型定义（UserInfo、LoginForm、LoginResponse）
- 创建通用类型定义（Result、PageResult、PageQuery）
- 创建 Pinia Store（user store with persistence）
- 创建路由配置（路由守卫、基础路由）
- 创建布局组件：
  - DefaultLayout.vue（侧边栏、头部、面包屑、用户下拉菜单）
  - BlankLayout.vue
- 创建页面组件：
  - login/index.vue（登录页面）
  - dashboard/index.vue（仪表盘页面）
  - error/404.vue（404错误页面）

### Testing:
- npm run build 构建成功
- TypeScript 类型检查通过

### Notes:
- Element Plus 使用 unplugin-auto-import 和 unplugin-vue-components 实现按需导入
- 用户状态使用 pinia-plugin-persistedstate 持久化到 localStorage
- 登录功能目前使用 mock 数据，需要后端 API 后对接

---

## 2026-02-27 - Task ID: 1 - 后端项目初始化

### What was done:
- 创建父POM (pom.xml)，配置Java 21、Spring Boot 3.4、Spring Cloud依赖管理
- 创建 moran-common 模块（公共工具类）
- 创建 moran-common-core 子模块：
  - Result<T> 统一响应类
  - ResultCode 枚举
  - BusinessException 业务异常类
  - GlobalExceptionHandler 全局异常处理器
  - Constants 常量类
- 创建 moran-common-redis 子模块：
  - RedisConfig 配置类
  - RedisService 服务类
- 创建 moran-common-security 子模块（空模块，后续开发）
- 创建 moran-common-mybatis 子模块：
  - BaseEntity 基础实体类
  - MybatisPlusConfig 配置类
  - JsonTypeHandler JSON类型处理器
- 创建 moran-gateway 模块（API网关）：
  - GatewayApplication 启动类
  - application.yml 配置文件
- 创建 moran-auth 模块（认证服务）：
  - AuthApplication 启动类
  - application.yml 配置文件
- 创建 moran-business 模块（核心业务服务）：
  - BusinessApplication 启动类
  - application.yml 配置文件
- 创建 moran-external 模块（外部对接服务）：
  - ExternalApplication 启动类
  - application.yml 配置文件
- 创建 moran-api 模块（Feign接口定义）：
  - moran-api-auth
  - moran-api-business
  - moran-api-external

### Testing:
- mvn clean compile 编译成功
- 所有模块依赖关系正确

### Notes:
- 由于Java 25与Lombok兼容性问题，移除了Lombok注解处理器
- 所有实体类改用手写getter/setter
- MyBatis Plus 3.5.9 的 PaginationInnerInterceptor 在当前版本中不存在，暂时移除分页插件
- 后续任务需要添加分页功能时可手动实现

---

## Template for New Entries

```
## [Date] - Task ID: [id] - [task title]

### What was done:
- [specific changes made]

### Testing:
- [how it was tested]

### Notes:
- [any relevant notes for future agents]
```
